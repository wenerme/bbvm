# BBASM 概述

## 字节码说明

### 寻址方法

| 表示 | 字节码 | 说明           |
| ---- | ------ | -------------- |
| rx   | 0x0    | 寄存器寻址     |
| [rx] | 0x1    | 寄存器间接寻址 |
| n    | 0x2    | 立即数寻址     |
| [n]  | 0x3    | 直接寻址       |

[参考](http://www.cs.iastate.edu/~prabhu/Tutorial/PIPELINE/addressMode.html)

### 两个操作数的寻址

| op1/op2 | rx  | [rx] | n   | [n] |
| ------- | --- | ---- | --- | --- |
| rx      | 0x0 | 0x1  | 0x2 | 0x3 |
| [rx]    | 0x4 | 0x5  | 0x6 | 0x7 |
| n       | 0x8 | 0x9  | 0xa | 0xb |
| [n]     | 0xc | 0xd  | 0xe | 0xf |

### 寄存器类型

| 寄存器 | 机器码 | 说明                                                        |
| ------ | ------ | ----------------------------------------------------------- |
| rp     | 0x0    | 程序计数器,指令寻址寄存器                                   |
| rf     | 0x1    | 标志寄存器,存储比较操作结果                                 |
| rs     | 0x2    | 栈寄存器 <br>空栈顶地址，指向的是下一个准备要压入数据的位置 |
| rb     | 0x3    | 辅助栈寄存器<br>栈开始的地址（文件长度+2）                  |
| r0     | 0x4    | #0 寄存器                                                   |
| r1     | 0x5    | #1 寄存器                                                   |
| r2     | 0x6    | #2 寄存器                                                   |
| r3     | 0x7    | #3 寄存器                                                   |

注意
: 默认栈大小为 1000b
: 假如 rb 和 rs 分别为 1260,260,那么 push 一次后, rb 变为 1256.
: 每 call 一次,向栈中写入一个返回地址
: `CMP int 2,1` 后, `rf` 为 4, 即 `A`,只会为 `A B N`, 即大于小于等于

### 数据类型

| 数据类型 | 机器码 |
| -------- | ------ | ----------------- |
| dword    | 0x0    | 32bit 和 INT 相同 |
| word     | 0x1    | 16 bit            |
| byte     | 0x2    | 8 bit             |
| float    | 0x3    | 32 bit 浮点数     |
| int      | 0x4    | 32 bit 整数       |

### 算术类型

| 算术类型 | 机器码 |
| -------- | ------ |
| ADD      | 0x0    |
| SUB      | 0x1    |
| MUL      | 0x2    |
| DIV      | 0x3    |
| MOD      | 0x4    |

### 比较操作

| 比较操作 | 机器码 | 说明       |
| -------- | ------ | ---------- |
| Z        | 0x1    | 等于       |
| B        | 0x2    | Below,小于 |
| BE       | 0x3    | 小于等于   |
| A        | 0x4    | Above,大于 |
| AE       | 0x5    | 大于等于   |
| NZ       | 0x6    | 不等于     |

### 指令

| 指令   | 机器码 | 说明         |
| ------ | ------ | ------------ |
| NOP    | 0x0    | 无操作       |
| LD     | 0x1    | 数据读写     |
| PUSH   | 0x2    | 入栈         |
| POP    | 0x3    | 出栈         |
| IN     | 0x4    | IN 端口调用  |
| OUT    | 0x5    | OUT 端口调用 |
| JMP    | 0x6    | 跳转         |
| JPC    | 0x7    | 条件跳转     |
| CALL   | 0x8    | 调用跳转     |
| RET    | 0x9    | 返回         |
| CMP    | 0xA    | 比较         |
| CAL    | 0xB    | 算术运算     |
| EXIT   | 0xF    | 退出         |
| DATA   | n/a    | 伪指令       |
| .BLOCK | n/a    | 伪指令       |

- NOP,RET,EXIT 无操作数 长度为 1
- JMP,PUSH,CALL,POP 一个操作数 长度为 5
- JPC 一个操作数 长度为 6
- LD,IN,OUT,CMP,CAL 两个操作数 长度为 10
- JPC 根据 rf 来判断是否跳转
- JPC 比较特殊,数据类型为**比较操作**,该指令只有 6 个字节
- CAL 使用特殊用途字节来指定算术类型
- CAL 数据类型 ADD 操作数 1, 操作数 2 返回值写入操作数 1
- CAL 在计算 BYTE,如果越界了,是直接减去 256,例如

```
ld int r1 300
cal int add r1,r1
; r1 的结果为 344 = 600 -256
```

- CAL 在计算 WORD,如果越界了,不清楚是怎么处理的
- LD 能处理 byte 和 word 的溢出问题,但是对于超过 int 或 dwrod 的溢出,不知道是怎么处理的
- `LD FLOAT` 和 `LD DWORD` 没有实际意义,和 `LD INT` 一样

## 指令的机器码构成

```
   指令码 + 数据类型 + 特殊用途字节 + 寻址方式 + 第一个操作数 + 第二个操作数
0x 0        0          0             0          0000           0000
```

- 在长度为 1 的操作码中, **数据类型** 为 **寻址方式**
- 在长度为 5 的操作码中,没有 `特殊用途字节 + 寻址方式`
- 无操作数的时候,寻址方式为 0
- 无数据类型,数据类型为 0
- CAL 使用特殊用途字节来指定算术类型
- JPC 比较特殊,数据类型为**比较操作**,该指令只有 6 个字节

# 端口说明

## IN

```
INT 输出参数, 端口
RETURN IN(ARGS...)
```

| 端口 | 功能                                                      | 返回值                                     | 参数列表                                                   | 备注                                                                                         |
| ---- | --------------------------------------------------------- | ------------------------------------------ | ---------------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| 0    | 浮点数转换为整数                                          | 整数                                       | r3:浮点数                                                  | int(r3.float)                                                                                |
| 1    | 整数转换为浮点数                                          | 浮点数                                     | r3:整数                                                    | float(r3.int)                                                                                |
| 2    | 申请字符串句柄                                            | 申请到的句柄                               |                                                            | strPool.acquire                                                                              |
| 3    | 字符串转换为整数                                          | 整数                                       | r3:字符串句柄,**地址**                                     | float(r3.str);若 r3 的值不是合法的字符串句柄则返回 r3 的值                                   |
| 4    | 整数转换为字符串                                          | 返回的值为 r3:整数                         | r2:目标字符串*句柄*<br>r3:整数                             | r2.str=str(r3.int);return r3.int;r2 所代表字符串的内容被修改                                 |
| 5    | 复制字符串                                                | r3 的值                                    | r2:源字符串句柄<br>r3:目标字符串句柄                       | r3.str=r2.str;return r3                                                                      |
| 6    | 连接字符串                                                | r3 的值                                    | r2:源字符串<br>r3:目标字符串                               | r3.str=r3.str+r2.str                                                                         |
| 7    | 获取字符串长度                                            | 字符串长度                                 | r3:字符串                                                  | strlen(r3.str)                                                                               |
| 8    | 释放字符串句柄                                            | r3 的值                                    | r3:字符串句柄                                              | strPool.release(r3);return r3                                                                |
| 9    | 比较字符串                                                | 两字符串的差值 相同为 0，大于为 1,小于为-1 | r2:基准字符串<br>r3:比较字符串                             | strcmp(r3.str,r2.str)                                                                        |
| 10   | 整数转换为浮点数再转换为字符串                            | r3 的值                                    | r2:目标字符串<br>r3:整数                                   | r2 所代表字符串的内容被修改                                                                  |
| 11   | 字符串转换为浮点数                                        | 浮点数                                     | r3:字符串                                                  |
| 12   | 获取字符的 ASCII 码                                       | ASCII 码                                   | r2:字符位置<br>r3:字符串                                   | GBK 编码,返回的结果范围为有符号的 8bit 值,因此对中文操作时返回负数                           |
| 13   | 将给定字符串中指定索引的字符替换为给定的 ASCII 代表的字符 | r3 的值                                    | r1:ASCII 码<br>r2:字符位置<br>r3:目标字符串                | r3 所代表字符串的内容被修改, 要求 r3 是句柄才能修改 r3 的值,给出的 ASCII 会进行模 256 的处理 |
| 14   | （功用不明）                                              | 65535                                      |                                                            |
| 15   | 获取嘀嗒计数                                              | 嘀嗒计数                                   |                                                            | 这里不知道他是怎么算的这个数字,但是会随着时间增长就是了                                      |
| 16   | 求正弦值                                                  | X!的正弦值                                 | r3:X!                                                      |
| 17   | 求余弦值                                                  | X!的余弦值                                 | r3:X!                                                      |
| 18   | 求正切值                                                  | X!的正切值                                 | r3:X!                                                      |
| 19   | 求平方根值                                                | X!的平方根值                               | r3:X!                                                      |
| 20   | 求绝对值                                                  | X%的绝对值                                 | r3:X%                                                      |
| 21   | 求绝对值                                                  | X!的绝对值                                 | r3:X!                                                      |
| 22   | 重定位数据指针                                            | r3 的值                                    | r2:数据位置                                                | r3 中为任意值                                                                                |
| 23   | 读内存数据                                                | 地址内容                                   | r3:地址                                                    |
| 24   | 写内存数据                                                | r3 的值                                    | r2:待写入数据<br>r3:待写入地址                             |
| 25   | 获取环境值                                                | 环境值                                     |                                                            |
| 32   | 整数转换为字符串                                          | r3 的值                                    | r1:整数<br>r3:目标字符串                                   | r3 所代表字符串的内容被修改                                                                  |
| 33   | 字符串转换为整数                                          | 整数                                       | r3:字符串                                                  |
| 34   | 获取字符第一个字符的 ASCII 码                             | ASCII 码                                   | r3:字符串                                                  |
| 35   | 左取字符串                                                | r3 的值                                    | r1:截取长度<br>r2:源字符串<br>r3:目标字符串                | r3 所代表字符串的内容被修改 （此端口似乎不正常）                                             |
| 36   | 右取字符串                                                | r3 的值                                    | r1:截取长度<br>r2:源字符串<br>r3:目标字符串                | r3 所代表字符串的内容被修改                                                                  |
| 37   | 中间取字符串                                              | r0 截取长度                                | r0:截取长度<br>r1:截取位置<br>r2:源字符串<br>r3:目标字符串 | r3 所代表字符串的内容被修改                                                                  |
| 38   | 查找字符串                                                | 位置                                       | r1:起始位置<br>r2:子字符串<br>r3:父字符串                  |
| 39   | 获取字符串长度                                            | 字符串长度                                 | r3:字符串                                                  |

注
: 23,24 端口在 pc 虚拟机上无法测试,实现的读写数据为 int
: 32,33,34,35,36,37 端口在 PC 虚拟机中有 bug,必须要传入的字符串长度大于等于转换后的长度,否则会出问题
: 36, 35 端口在 PC 虚拟机中有 BUG
: StdLib 中对 LEFT$ 的定义似乎也有问题,只使用了一个参数
: 直接汇编操作 35 36 端口的时候,长度会加一,BUG
: 38 查找不到时返回 0, BUG

## OUT

| 端口 | 功能                             | 输出的数据      | 参数列表                                        | 备注                                         |
| ---- | -------------------------------- | --------------- | ----------------------------------------------- | -------------------------------------------- |
| 0    | 显示整数                         | 整数            |                                                 | 会换行                                       |
| 1    | 显示字符串                       | 字符串          |                                                 | 会换行                                       |
| 2    | 显示字符串                       | 字符串          |                                                 |
| 3    | 显示整数                         | 整数            |                                                 |
| 4    | 显示字符                         | 字符 ASCII 码   |                                                 |
| 5    | 显示浮点数                       | 浮点数          |                                                 |
| 10   | 键入整数                         | 0               |                                                 | r3 的值变为键入的整数                        |
| 11   | 键入字符串                       | 0               | r3:目标字符串句柄                               | r3 所指字符串的内容变为键入的字符串          |
| 12   | 键入浮点数                       | 0               |                                                 | r3 的值变为键入的浮点数                      |
| 13   | 从数据区读取整数                 | 0               |                                                 | r3 的值变为读取的整数                        |
| 14   | 从数据区读取字符串               | 0               | r3:目标字符串句柄                               | r3 所指字符串的内容变为读取的字符串          |
| 15   | 从数据区读取浮点数               | 0               |                                                 | r3 的值变为读取的浮点数                      |
| 16   | 设定模拟器屏幕                   | 0               | r2:宽, r3:高                                    | SETLCD(WIDTH,HEIGHT)                         |
| 17   | 申请画布句柄                     | 0 ,r3:PAGE 句柄 | -                                               | CREATEPAGE()                                 |
| 18   | 释放画布句柄                     | 0               | r3:PAGE 句柄                                    | DELETEPAGE(PAGE)                             |
| 19   | 申请图片句柄并从文件载入像素资源 | r3:资源句柄     | r3:文件名, r2:资源索引                          | LOADRES(FILE$,ID)                            |
| 20   | 复制图片到画布上                 | 0               | r3:地址,其他参数在该地址后                      | SHOWPIC(PAGE,PIC,DX,DY,W,H,X,Y,MODE)         |
| 21   | 显示画布                         | 0               | r3:PAGE 句柄                                    | FLIPPAGE(PAGE)                               |
| 22   | 复制画布                         | 0               | r2:目标 PAGE 句柄,r3:源 PAGE 句柄               | BITBLTPAGE(DEST,SRC)                         |
| 23   | 填充画布                         | 0               | r3:参数地址                                     | FILLPAGE(PAGE,X,Y,WID,HGT,COLOR)             |
| 24   | 写入画布某点颜色                 | 0               | r3:参数地址                                     | PIXEL(PAGE,X,Y,COLOR)                        |
| 25   | 读取画布某点颜色                 | 0               | r3:参数地址                                     | READPIXEL(PAGE,X,Y)                          |
| 26   | 释放图片句柄                     | 0               | r3:资源句柄                                     | FREERES(ID)                                  |
| 27   | 延迟一段时间                     | 0               | r3:延迟时间                                     | MSDELAY(MSEC)                                |
| 32   | 用种子初始化随机数生成器         | 0               | r3:SEED                                         | RANDOMIZE(SEED)                              |
| 33   | 获取范围内随机数                 | 0               | r3:RANGE                                        | RND(RANGE)                                   |
| 34   | 判定某键是否按下                 | 0;r3            | r3:KEY                                          | KEYPRESS(KEY)                                |
| 35   | 清屏                             | 0               |                                                 |
| 36   | 按行列定位光标                   | 0               | r2:行,r3:列                                     | LOCATE(LINE,ROW)                             |
| 37   | 设定文字颜色                     | 0               | r3:参数地址                                     | COLOR(FRONT,BACK,FRAME)                      |
| 38   | 设定文字字体大小                 | 0               | r3:FONT                                         | FONT(F)                                      |
| 39   | 等待按键                         | r3:按键         | -                                               | WAITKEY()                                    |
| 40   | 获取图片宽度                     | r3              | r3                                              | GETPICWID(PIC)                               |
| 41   | 获取图片高度                     | r3              | r3                                              | GETPICHGT(PIC)                               |
| 42   | 按坐标定位光标                   | -               | r2:行,r3:列                                     | PIXLOCATE(LINE,ROW)                          |
| 43   | 复制部分画布                     | -               | r3:参数地址                                     | STRETCHBLTPAGE(X,Y,DEST,SRC)                 |
| 44   | 设定背景模式                     | r3:MODE         | -                                               | SETBKMODE(mode)                              |
| 45   | 获取按键的字符串                 | 0               | r3:字符串句柄,用于存储结果                      | InKey$                                       |
| 46   | 获取按键的 ASCII 码              | 0               | r3:KEYPRESS                                     | INKEY()                                      |
| 48   | 打开文件                         | 0               | r0:打开方式<br>r1:文件号<br>r3:文件名字符串     | 打开方式目前只能为 1                         |
| 49   | 关闭文件                         | 文件号          |                                                 |
| 50   | 从文件读取数据                   | 16:读取整数     | r1:文件号<br>r2:位置偏移量                      | r3 的值变为读取的整数                        |
| -    |                                  | 17:读取浮点数   | r1:文件号<br>r2:位置偏移量                      | r3 的值变为读取的浮点数                      |
| -    |                                  | 18:读取字符串   | r1:文件号<br>r2:位置偏移量<br>r3:目标字符串句柄 | r3 所指字符串的内容变为读取的字符串          |
| 51   | 向文件写入数据                   | 16:写入整数     | r1:文件号<br>r2:位置偏移量<br>r3:整数           |
| -    |                                  | 17:写入浮点数   | r1:文件号<br>r2:位置偏移量<br>r3:浮点数         |
| -    |                                  | 18:写入字符串   | r1:文件号<br>r2:位置偏移量<br>r3:字符串         |
| 52   | 判断文件位置指针是否指向文件尾   | 0;r3 为 0 或 1  | r3:文件号                                       | Eof                                          |
| 53   | 获取文件长度                     | 0               | r3:文件号                                       | Lof                                          |
| 54   | 获取文件位置指针的位置           | 0;返回值在 r3   | r3:文件号                                       | LOC(FILE)                                    |
| 55   | 定位文件位置指针                 | 16              | r2:文件号<br>r3:目标位置                        |
| 64   | 设置画笔                         | 0               | r3:参数地址                                     | SETPEN(PAGE,STYLE,WID,COLOR)                 |
| 65   | 设置刷子                         | 0               | r2:PAGE r3:STYLE                                | SETBRUSH(PAGE,STYLE)                         |
| 66   | 移动画笔                         | 0               | r1,r2,r3:PAGE,X,Y                               | MOVETO(PAGE,X,Y)                             |
| 67   | 画线                             | 0               | r1,r2,r3:PAGE,X,Y                               | LINETO(PAGE,X,Y)                             |
| 68   | 画矩形                           | 0               | r3:参数地址                                     | RECTANGLE(PAGE,LEFT,TOP,RIGHT,BOTTOM)        |
| 69   | 画圆                             | 0               | r3:参数地址                                     | CIRCLE(PAGE,CX,CY,CR)                        |
| 80   | 复制部分画布扩展                 | 0               | r3:参数地址                                     | STRETCHBLTPAGEEX(X,Y,WID,HGT,CX,CY,DEST,SRC) |
| 255  | 虚拟机测试                       | 0               | 0                                               | VmTest                                       |

TIPS

- 参数中的颜色为 BGR 制式
- PAGE 如果为 -1 则为屏幕
- PAGE 句柄从 0 开始

# 杂项

## 主要资源类型

- 字符串句柄: -1 开始
- 资源句柄: 0 开始 失败会返回 -1
- 文件句柄: 自己指定 0 开始

# 图片格式

| 后缀 | 机型 | 说明                                           | ByteOrder     |
| ---- | ---- | ---------------------------------------------- | ------------- |
| rlb  | n/a  | 用于 PC 端的 ResMaker<br>存储的主要是 BMP 数据 | Litter-Endian |
| lib  | 9688 | RGB565 格式                                    | Litter-Endian |
| lib  | 9288 | 4 阶灰                                         | Litter-Endian |
| lib  | 9188 | 4 阶灰                                         | Big-Endian    |
| dlx  | 9688 | 用于存储系统图像                               | Litter-Endian |

## rlb

```
number.uint32
(offset.uint32 name.[32]byte)*number
(length.uint32 data.[length - 4]byte)*number
```

## lib

```
number.uint32
(offset.uint32)*number
(length.uint32 width.uint16 height.uint16 data.[length - 12]byte)*number
```

## dlx

**TODO**

# Note

- BB 为 LITTLE_ENDIAN
- 原始编码为 GBK
- 给定一个地址作为参数地址开始的参数,都是逆序的,例如
  ```
  ; SHOWPIC(PAGE,PIC,DX,DY,W,H,X,Y,MODE)
  data SHOWPIC_PARAM_INV int MODE, 0, 0, 320, 240, 0, 0, 0, PAGE
  ```
- BBAsm 的数据标签和跳转标签大小写敏感
- BBAsm 的指令大小写不敏感

## BB 函数

## TODO

句柄是否会重用
栈的具体布局和行为

## 文件与内存布局

```
文件结构
|<--文件头-->|<--执行内容-->|

内存结构
|<--内存-->|<--栈-->|
```

- 文件头
  - 16 byte
- 栈
  - 1024 byte
